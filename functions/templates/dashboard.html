<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Öğrenci Yönetim Sistemi – Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle at top, #e0f2fe, #eef2ff);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .navbar-gradient {
      background: linear-gradient(90deg, #1d4ed8, #4f46e5);
    }
    .glass {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.10);
    }
    .status-badge {
      padding: 0.1rem 0.65rem;
      font-size: 0.75rem;
      border-radius: 999px;
      font-weight: 600;
    }
    .status-open {
      background: #fef3c7;
      color: #92400e;
    }
    .status-done {
      background: #dcfce7;
      color: #166534;
    }
    .table thead {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
    }
    .table tbody tr {
      vertical-align: middle;
    }
    .filter-pill {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #6b7280;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-gradient navbar-dark mb-4">
  <div class="container-fluid px-4">
    <a class="navbar-brand fw-semibold" href="{{ url_for('dashboard') }}">
      <i class="bi bi-mortarboard me-2"></i>Öğrenci Yönetim Sistemi
    </a>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <span class="badge bg-light text-dark d-none d-md-inline-flex align-items-center">
        <i class="bi bi-person-circle me-1"></i>{{ current_user.username }}
      </span>
      <a href="{{ url_for('main_screen') }}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-bar-chart-line me-1"></i>İstatistikler
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-box-arrow-right"></i>
      </a>
    </div>
  </div>
</nav>

<div class="container-fluid px-4">
  {# Flash mesajlar #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="row mb-3">
        <div class="col-12">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} py-2 small mb-1">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  {# Filtreler - tek satır #}
  <div class="glass p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <div class="filter-pill mb-1">Filtreler</div>
        <div class="small text-muted">
          Toplam <strong>{{ students|length }}</strong> öğrenci
        </div>
      </div>
      <a href="{{ url_for('add_student') }}" class="btn btn-success btn-sm">
        <i class="bi bi-person-plus me-1"></i>Öğrenci Ekle
      </a>
    </div>

    <form class="row gy-2 gx-2 align-items-end" method="GET" action="{{ url_for('dashboard') }}">
      <div class="col-12 col-md-3 col-lg-3">
        <label class="form-label small mb-1">Ara</label>
        <input type="text" name="q" class="form-control form-control-sm"
               placeholder="İsim / telefon / okul no"
               value="{{ q or '' }}">
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <label class="form-label small mb-1">Durum</label>
        <select name="status" class="form-select form-select-sm">
          <option value="" {{ '' == status and 'selected' or '' }}>Hepsi</option>
          <option value="cozulmedi" {{ status == 'cozulmedi' and 'selected' or '' }}>Çözülmedi</option>
          <option value="cozuldu" {{ status == 'cozuldu' and 'selected' or '' }}>Çözüldü</option>
        </select>
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <label class="form-label small mb-1">Fakülte</label>
        <select name="faculty" id="facultyFilter" class="form-select form-select-sm">
          <option value="">Fakülte (hepsi)</option>
          {% for fac in faculties.keys() %}
            <option value="{{ fac }}" {% if faculty==fac %}selected{% endif %}>{{ fac }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <label class="form-label small mb-1">Bölüm</label>
        <select name="department"
                id="departmentFilter"
                class="form-select form-select-sm"
                data-current-dept="{{ department or '' }}">
          <option value="">Bölüm (hepsi)</option>
        </select>
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <label class="form-label small mb-1">Ekleyen Kullanıcı</label>
        <select name="added_by" class="form-select form-select-sm">
          <option value="" {{ not added_by and 'selected' or '' }}>Hepsi</option>
          {% for u in added_by_options %}
            <option value="{{ u }}" {% if added_by==u %}selected{% endif %}>{{ u }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-1 col-lg-1 d-flex gap-2 justify-content-end">
        <button type="submit" class="btn btn-primary btn-sm w-100 w-md-auto">
          <i class="bi bi-funnel me-1"></i>Filtrele
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm d-none d-md-inline-flex">
          Temizle
        </a>
      </div>
    </form>
  </div>

  {# Liste #}
  <div class="glass p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <div class="small text-muted">Öğrenci Listesi</div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th style="width:60px;">#</th>
            <th>Ad Soyad</th>
            <th>İletişim</th>
            <th>Okul No</th>
            <th>Fakülte / Bölüm</th>
            <th>Durum</th>
            <th>Ekleyen</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>
        <tbody>
        {% if students %}
          {% for s in students %}
            <tr>
              <td class="text-muted small">{{ loop.index }}</td>
              <td class="fw-semibold">{{ s.name }}</td>
              <td>
                {% if s.phone %}
                  <i class="bi bi-telephone me-1 text-muted"></i>{{ s.phone }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>{{ s.school_no or '—' }}</td>
              <td>
                {% if s.faculty %}
                  <div class="fw-semibold small">{{ s.faculty }}</div>
                {% endif %}
                {% if s.department %}
                  <div class="text-muted small">{{ s.department }}</div>
                {% endif %}
                {% if not s.faculty and not s.department %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if s.status == 'cozuldu' %}
                  <span class="status-badge status-done">Çözüldü</span>
                {% else %}
                  <span class="status-badge status-open">Çözülmedi</span>
                {% endif %}
              </td>
              <td class="small text-muted">{{ s.added_by or '—' }}</td>
              <td class="text-center">
                <a href="{{ url_for('view_student', id=s.id) }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              Kayıt bulunamadı.
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Fakülte -> Bölüm cascade (dashboard filtreleri)
  document.addEventListener('DOMContentLoaded', function () {
    const mapping = {{ faculties | tojson | safe }};
    const facSel  = document.getElementById('facultyFilter');
    const depSel  = document.getElementById('departmentFilter');
    const currentDept = depSel.dataset.currentDept || "";

    function refreshDepartments() {
      const fac = facSel.value;
      depSel.innerHTML = "";
      let opts = [];

      if (!fac || !mapping[fac]) {
        opts.push(new Option("Bölüm (hepsi)", ""));
      } else {
        opts.push(new Option("Bölüm (hepsi)", ""));
        mapping[fac].forEach(dep => {
          const o = new Option(dep, dep);
          if (dep === currentDept) {
            o.selected = true;
          }
          opts.push(o);
        });
      }
      opts.forEach(o => depSel.add(o));
    }

    refreshDepartments();
    facSel.addEventListener('change', function () {
      depSel.dataset.currentDept = "";
      refreshDepartments();
    });
  });
</script>

</body>
</html>
