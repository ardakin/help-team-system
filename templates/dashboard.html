<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Help Team • Öğrenci Listesi</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body{background:#f6f8fb}
    .glass{background:#fff;border:1px solid #e8ecf2;border-radius:14px;box-shadow:0 10px 30px rgba(13,110,253,.06)}
    .toolbar .form-control,.toolbar .form-select{border-radius:10px}
    th,td{vertical-align:middle!important}
    thead th{background:#f1f4f8}
    .table>:not(caption)>*>*{padding:.85rem .9rem}

    /* Chip */
    .chip{
      display:inline-flex;align-items:center;justify-content:center;gap:.35rem;
      padding:.35rem .65rem;border-radius:999px;font-size:.82rem;font-weight:500;
      min-width:90px;text-align:center
    }
    .chip-success{background:#e6f9f0;color:#0f6848;border:1px solid #b8ead0}
    .chip-warn{background:#fff5cc;color:#7a6300;border:1px solid #f2da7b}

    /* İşlemler sütunu: formu linklerle aynı hizaya getir */
    td .actions { display:inline-flex; align-items:center; gap:.25rem; }
    td .actions form { display:inline-block; margin:0; }
    /* buton sınırlarının birleştiğinde boşluk olmaması için */
    .btn-group-merge > *:not(:first-child){ margin-left:-1px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container-xxl">
    <a class="navbar-brand fw-semibold" href="{{ url_for('dashboard') }}">
      <i class="bi bi-grid-1x2-fill me-1"></i>Help Team
    </a>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main_screen') }}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-bar-chart-line me-1"></i>Liste
      </a>
      <a href="{{ url_for('add_student') }}" class="btn btn-success btn-sm">
        <i class="bi bi-person-plus me-1"></i>Öğrenci Ekle
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-box-arrow-right me-1"></i>Çıkış
      </a>
    </div>
  </div>
</nav>

<div class="container-xxl py-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert alert-{{ cat if cat in ['success','danger','warning'] else 'info' }} glass">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- FİLTRELER -->
  <div class="glass p-3 p-md-4 mb-4">
    <form class="row g-3 toolbar align-items-end" method="get" action="{{ url_for('dashboard') }}">
      <div class="col-12 col-lg-4">
        <label class="form-label small text-muted">Genel Arama</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input name="q" class="form-control" placeholder="İsim, Telefon veya Okul No" value="{{ q or '' }}">
        </div>
      </div>

      <div class="col-6 col-lg-3">
        <label class="form-label small text-muted">Fakülte</label>
        <input name="faculty" id="filterFaculty" class="form-control" list="facultyList"
               placeholder="Fakülte (hepsi)" value="{{ faculty }}">
        <datalist id="facultyList">
          {% for fac in faculties.keys() %}<option value="{{ fac }}"></option>{% endfor %}
        </datalist>
      </div>

      <div class="col-6 col-lg-3">
        <label class="form-label small text-muted">Bölüm</label>
        <input name="department" id="filterDepartment" class="form-control" list="departmentList"
               placeholder="Bölüm (hepsi)" value="{{ department }}">
        <datalist id="departmentList"></datalist>
      </div>

      <div class="col-6 col-lg-1">
        <label class="form-label small text-muted">Durum</label>
        <select name="status" class="form-select">
          <option value="" {{ ''==status and 'selected' or '' }}>Hepsi</option>
          <option value="cozulmedi" {{ status=='cozulmedi' and 'selected' or '' }}>Çözülmedi</option>
          <option value="cozuldu" {{ status=='cozuldu' and 'selected' or '' }}>Çözüldü</option>
        </select>
      </div>

      <div class="col-6 col-lg-1">
        <label class="form-label small text-muted">Ekleyen</label>
        <input name="added_by" class="form-control" list="addedByList"
               placeholder="Hepsi" value="{{ added_by or '' }}">
        <datalist id="addedByList">
          {% for u in added_by_options %}<option value="{{ u }}"></option>{% endfor %}
        </datalist>
      </div>

      <div class="col-12">
        <button class="btn btn-primary px-4"><i class="bi bi-funnel me-1"></i> Ara</button>
      </div>
    </form>
  </div>

  <!-- TABLO -->
  <div class="glass">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>İsim</th>
            <th>Telefon</th>
            <th>Okul No</th>
            <th>Bölüm</th>
            <th>Fakülte</th>
            <th>Durum</th>
            <th>Ekleyen</th>
            <th class="text-end">İşlemler</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td>
              <a href="{{ url_for('view_student', id=s.id) }}" class="fw-semibold text-decoration-none">
                {{ s.name }}
              </a>
            </td>
            <td>{{ s.phone or '-' }}</td>
            <td>{{ s.school_no or '-' }}</td>
            <td>{{ s.department or '-' }}</td>
            <td>{{ s.faculty or '-' }}</td>
            <td>
              {% if s.status=='cozuldu' %}
                <span class="chip chip-success"><i class="bi bi-check2-circle"></i> Çözüldü</span>
              {% else %}
                <span class="chip chip-warn"><i class="bi bi-exclamation-circle"></i> Çözülmedi</span>
              {% endif %}
            </td>
            <td>{{ s.added_by or '—' }}</td>

            <td class="text-end text-nowrap">
              <div class="actions btn-group-merge">
                <a href="{{ url_for('edit_student', id=s.id) }}" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-pencil-square"></i> Düzenle
                </a>
                <a href="{{ url_for('view_student', id=s.id) }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-card-text"></i> Detay
                </a>
                <form method="post" action="{{ url_for('delete_student', id=s.id) }}"
                      onsubmit="return confirm('Silinsin mi?')">
                  <button class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash3"></i> Sil
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">Kayıt bulunamadı.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const FACULTY_DEPARTMENTS = {{ faculties | tojson }};
  const fFac = document.getElementById('filterFaculty');
  const depList = document.getElementById('departmentList');
  const presetFaculty = "{{ faculty or '' }}";

  function fillDeptDatalist(fac){
    depList.innerHTML = "";
    if (fac && FACULTY_DEPARTMENTS[fac]){
      FACULTY_DEPARTMENTS[fac].forEach(d=>{
        const o=document.createElement('option'); o.value=d; depList.appendChild(o);
      });
    }
  }

  fillDeptDatalist(presetFaculty);
  fFac.addEventListener('input', e => fillDeptDatalist(e.target.value));
</script>
</body>
</html>
